from pydantic import BaseModel

from core import make_prompt, llm_request, llm_model

chat = """[
        {
            "id": 1,
            "sender_id": "0",
            "content": "안녕하세요, 물건 아직 있나요?",
            "timestamp": "2025-09-20T18:45:00"
        },
        {
            "id": 2,
            "sender_id": "1",
            "content": "안녕하세요! 네, 아직 판매 중입니다. 더 자세한 얘기는 카톡오픈채팅에서 가능할까요?",
            "timestamp": "2025-09-20T18:46:00"
        },
        {
            "id": 3,
            "sender_id": "0",
            "content": "여기서 얘기하면 안 될까요? 오픈채팅은 좀 불편해서요.",
            "timestamp": "2025-09-20T18:47:00"
        },
        {
            "id": 4,
            "sender_id": "1",
            "content": "여기서는 알림을 놓칠 수 있어서요. 안전하게 거래하려면 오픈채팅이 더 좋습니다. 링크 보내드릴게요!",
            "timestamp": "2025-09-20T18:48:00"
        },
        {
            "id": 5,
            "sender_id": "0",
            "content": "음... 그래도 좀 걱정되네요. 여기서 그냥 하면 안 될까요?",
            "timestamp": "2025-09-20T18:49:00"
        },
        {
            "id": 6,
            "sender_id": "1",
            "content": "걱정 마세요! 오픈채팅에서만 대화하고 거래는 여기서 해도 됩니다. 링크는 https://kakao.com/o/abcd123로 들어오시면 돼요.",
            "timestamp": "2025-09-20T18:50:00"
        }
    ]
"""

ref_docs = """
    [EXT_MESSENGER] 외부 메신저 유도

    설명: 플랫폼 밖(텔레그램/카톡 오픈채팅/DM 등)으로 대화를 옮기도록 유도해 안전장치를 회피.

    포함 신호: 카톡오픈, 오픈채팅 링크, 톡아이디, 텔레, t.me, 디엠, 라인으로 얘기, kakao.com/o 링크.

    제외 신호: 플랫폼 내 결제·채팅 고수, 공식 고객센터 안내(화이트리스트 링크).

    판정 규칙: 외부 메신저 이동 요구가 1회 이상이면 매칭. 화이트리스트 도메인 안내 목적은 제외.

    심각도: 중간

    권고 행동: 외부 메신저 이동 자제 경고, 플랫폼 내 안전결제 권고.

    [PREPAY] 선입금/보증금 요구

    설명: 물건 확인 전 선입금/예약금/보증금 요구 또는 입금 먼저 강요.

    포함 신호: 선입금, 예약금, 보증금, 입금 먼저, 선결제, 계좌부터, 계좌번호 제시.

    제외 신호: 플랫폼 에스크로 결제, 대면 후 이체.

    판정 규칙: 선입금 표현 + 계좌 제시가 함께 있으면 강 매칭. 계좌 없이 예약 문의는 보류.

    심각도: 높음

    권고 행동: 선입금 금지 안내, 계좌 공유 금지, 신고/차단 버튼 노출.

    [FAKE_ESCROW] 가짜 안전결제/피싱

    설명: 공식 안전결제를 사칭한 유사 도메인/가짜 UI 링크로 결제 유도.

    포함 신호: 안전결제 링크, 에스크로 결제창, 송장 확인 링크, 단축 URL, 의심 도메인.

    제외 신호: 공식 도메인(예: pay.naver.com, order.coupang.com, 공식 택배사).

    판정 규칙: ‘안전결제/에스크로’ 언급 + 비화이트리스트 도메인 URL 동시 존재 시 매칭.

    심각도: 높음

    권고 행동: 링크 미리보기 차단, 피싱 경고 배너, 신고 유도.

    [FAKE_ITEM_OR_NO_SHIP] 허위매물/미발송

    설명: 실재하지 않는 물건 또는 선입금 후 지연·잠적. 혹은 발송 약속만 반복.

    포함 신호: 시세 대비 과도한 저가, 오늘만 이 가격/급처, 입금하면 바로 발송, 입금 후 지속 지연.

    제외 신호: 정상 운송장 공유 + 실제 수령 확인.

    판정 규칙: 시세 괴리 + 선입금/지연·잠적 맥락 반복 시 매칭.

    심각도: 높음

    권고 행동: 선입금 금지 재안내, 거래 중지 권고.

    [WRONG_ITEM_OR_QUALITY] 다른 물품/불량 발송

    설명: 설명/사진과 다른 물건 또는 불량품 발송 후 환불 회피.

    포함 신호: 설명이랑 다름/다른 모델 도착/하자 숨김/상태 상이.

    제외 신호: 하자 사전 고지 + 합의된 가격.

    판정 규칙: 상태/모델 상이 지적 + 환불 회피 표현이 결합되면 매칭.

    심각도: 중간

    권고 행동: 환불·분쟁 가이드 제공, 증빙 업로드 유도.

    [COUNTERFEIT] 가품(위조) 판매

    설명: 위조품을 정품으로 속여 판매.

    포함 신호: 과도히 저렴한 가격, 정품 강변, 저화질 감정서/보증서 사진.

    제외 신호: 공식 감정/영수증 확인으로 진위 일치.

    판정 규칙: 정품 강변 + 시세 괴리 + 증빙 신뢰도 낮음이면 매칭.

    심각도: 높음

    권고 행동: 정품 인증 방법 안내, 거래 보류 권고.

    [THIRD_PARTY_MEDIATION] 3자 사기(중개형)

    설명: 사기꾼이 구매자/판매자 사이에 끼어 양쪽을 속여 돈·물건 편취.

    포함 신호: 대리 거래, 지인 대신 수령, 입금 계좌/수령인/대화 상대 불일치, 모호한 중개 설명.

    제외 신호: 공식 대행/탁송 서비스.

    판정 규칙: 계좌·수령인·연락처 중 2개 이상 불일치 + 중개 모호 시 매칭.

    심각도: 높음

    권고 행동: 한 채널·한 당사자 원칙 안내, 입금·수령 정보 일치 확인.

    [ID_OR_ACCOUNT_FRAUD] 신분/계좌 도용

    설명: 도용 신분증·대포통장 사용 정황.

    포함 신호: 신분증 사진 전달(이상한 모자이크/각도), 명의자와 입금주 불일치, 계좌 변경 요구.

    제외 신호: 명의 일치 확인.

    판정 규칙: 입금주/연락처/수령인/신분증 이름 중 2개 이상 불일치 시 매칭.

    심각도: 높음

    권고 행동: 본인확인 경고, 거래 중단 권고, 신고 안내.

    [PRESSURE_OR_URGENCY] 과도한 압박/긴급성 조성

    설명: 짧은 시간 내 결정을 강요하여 정상 검증 방해.

    포함 신호: 지금 바로/5분 안에/다른 분도 대기/오늘만.

    제외 신호: 상식적 예약·대기 안내.

    판정 규칙: 시간 압박 표현 반복 + 결제/선입금 요구와 결합 시 다른 유형 가중.

    심각도: 중간

    권고 행동: 충분한 검토 권고, 안전결제/직거래 유도.
"""

try:
    prompt = make_prompt(chat, ref_docs)
    response = llm_request(llm_model, prompt)
    print(response)
except Exception as e:
    print(str(e))
